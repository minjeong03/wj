<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My To-Do List</title>
  <style>
    body {
      font-family: "Pretendard", sans-serif;
      background: #f7f7f7;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 10px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #todoInput {
      width: 250px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    #saveBtn, #clearBtn {
      margin-left: 8px;
      padding: 10px 16px;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #saveBtn:hover, #clearBtn:hover {
      background-color: #005fcb;
    }
    ul {
      margin-top: 30px;
      list-style: none;
      padding: 0;
      width: 300px;
    }
    li {
      background: white;
      margin-bottom: 8px;
      padding: 10px 14px;
      border-radius: 6px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    li.done {
      text-decoration: line-through;
      color: #888;
    }
    button.delete {
      background: none;
      border: none;
      color: #d33;
      cursor: pointer;
      font-size: 16px;
    }
    /* ğŸŒ€ ë¡œë”© ìŠ¤í”¼ë„ˆ */
    #spinner {
      display: none;
      margin-top: 30px;
      border: 4px solid #eee;
      border-top: 4px solid #007aff;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>ì˜¤ëŠ˜ì˜ í•  ì¼</h1>
  <div>
    <input id="todoInput" type="text" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" />
    <button id="saveBtn">ì €ì¥</button>
    <button id="clearBtn" style="background-color:#ff3b30">ì§€ë‚œ í•­ëª© ì •ë¦¬</button>
  </div>

  <div id="spinner"></div>
  <ul id="todoList"></ul>

  <script>
    // âœ… Google Apps Script Web App URL
    const GAS_URL =
      "https://script.google.com/macros/s/AKfycby8nkwH7I5hp7S0aVCK2jGP4C7UelXDumpg-osvsvUhtPDZnAAmqGl3FqzqWNsCPY2E/exec";

    // âœ… Cloudflare Worker Proxy URL (ìì‹ ì˜ Worker ì£¼ì†Œë¡œ êµì²´)
    const PROXY_URL = "https://lingering-silence-aad0.minjeongkim-digipen.workers.dev/?url=";

    const input = document.getElementById("todoInput");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const list = document.getElementById("todoList");
    const spinner = document.getElementById("spinner");

    function showSpinner(show) {
      spinner.style.display = show ? "block" : "none";
    }

    // ğŸ“¥ Todo ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadTodos() {
      showSpinner(true);
      try {
        const res = await fetch(
          PROXY_URL + encodeURIComponent(GAS_URL + "?action=list")
        );
        const text = await res.text();
        const todos = JSON.parse(text);
        list.innerHTML = "";
        todos.forEach((item, i) => {
          const li = document.createElement("li");
          li.textContent = item.text;
          li.classList.toggle("done", item.done);
          li.addEventListener("click", () => toggleDone(i));

          const del = document.createElement("button");
          del.textContent = "âœ•";
          del.className = "delete";
          del.addEventListener("click", (e) => {
            e.stopPropagation();
            deleteTodo(i);
          });

          li.appendChild(del);
          list.appendChild(li);
        });
      } catch (err) {
        console.error("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
        list.innerHTML = "<li style='color:gray'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¢</li>";
      } finally {
        showSpinner(false);
      }
    }

    // ğŸ“¤ Todo ì €ì¥
    async function saveTodo() {
      const todo = input.value.trim();
      if (!todo) return alert("í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”!");

      showSpinner(true);
      try {
        const res = await fetch(PROXY_URL + encodeURIComponent(GAS_URL), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "add", todo }),
        });
        const text = await res.text();
        const data = JSON.parse(text);
        if (data.success) {
          input.value = "";
          await loadTodos();
        } else {
          alert("ì €ì¥ ì‹¤íŒ¨!");
        }
      } catch (err) {
        console.error("ì €ì¥ ì˜¤ë¥˜:", err);
        alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢");
      } finally {
        showSpinner(false);
      }
    }

    // âœ… ì™„ë£Œ/ì·¨ì†Œ í† ê¸€
    async function toggleDone(index) {
      showSpinner(true);
      try {
        const res = await fetch(PROXY_URL + encodeURIComponent(GAS_URL), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "toggle", index }),
        });
        const text = await res.text();
        const result = JSON.parse(text);
        if (result.success) await loadTodos();
      } catch (err) {
        console.error("í† ê¸€ ì‹¤íŒ¨:", err);
      } finally {
        showSpinner(false);
      }
    }

    // âŒ ì‚­ì œ
    async function deleteTodo(index) {
      showSpinner(true);
      try {
        const res = await fetch(PROXY_URL + encodeURIComponent(GAS_URL), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "delete", index }),
        });
        const text = await res.text();
        const result = JSON.parse(text);
        if (result.success) await loadTodos();
      } catch (err) {
        console.error("ì‚­ì œ ì‹¤íŒ¨:", err);
      } finally {
        showSpinner(false);
      }
    }

    // ğŸ§¹ ì§€ë‚œ í•­ëª© ì •ë¦¬
    async function clearOldTodos() {
      if (!confirm("ì˜¤ëŠ˜ ë‚ ì§œê°€ ì•„ë‹Œ ëª¨ë“  í•  ì¼ì„ ì‚­ì œí• ê¹Œìš”?")) return;

      showSpinner(true);
      try {
        const res = await fetch(
          PROXY_URL + encodeURIComponent(GAS_URL + "?action=clearOld")
        );
   
      } catch (err) {
        console.error("ì •ë¦¬ ì‹¤íŒ¨:", err);
        alert("ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      } finally {
        showSpinner(false);
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    saveBtn.addEventListener("click", saveTodo);
    clearBtn.addEventListener("click", clearOldTodos);
    window.addEventListener("load", loadTodos);
  </script>
</body>
</html>
